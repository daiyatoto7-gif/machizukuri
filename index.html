<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Builder Grid</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --panel-bg: #ffffff;
            --accent-color: #3498db;
            --text-color: #2c3e50;
            --border-color: #dfe6e9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨è³‡æºè¡¨ç¤º */
        header {
            width: 100%;
            background: var(--panel-bg);
            padding: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: fixed;
            top: 0;
            z-index: 10;
            display: flex;
            justify-content: center;
        }

        .resource-bar {
            display: flex;
            gap: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .res-item span { color: var(--accent-color); }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        main {
            margin-top: 80px;
            display: flex;
            gap: 20px;
            padding: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* ãƒãƒƒãƒ— (ã‚°ãƒªãƒƒãƒ‰) */
        #map-grid {
            display: grid;
            grid-template-columns: repeat(5, 80px); /* 5x5 */
            grid-template-rows: repeat(5, 80px);
            gap: 5px;
            background: #bdc3c7;
            padding: 5px;
            border-radius: 8px;
        }

        .tile {
            width: 80px;
            height: 80px;
            background-color: #ecf0f1;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            text-align: center;
            transition: background 0.2s;
            user-select: none;
        }

        .tile:hover { background-color: #d1ecf1; }
        .tile.active { border: 2px solid var(--accent-color); background-color: #dbeeff; }
        
        .tile-icon { font-size: 24px; margin-bottom: 4px; }
        .tile-level { font-size: 10px; color: #7f8c8d; }
        .progress-bar { width: 80%; height: 4px; background: #ddd; margin-top: 2px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2ecc71; width: 0%; transition: width 0.2s linear; }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        #control-panel {
            width: 300px;
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        h2 { margin-top: 0; font-size: 1.2em; border-bottom: 2px solid var(--bg-color); padding-bottom: 10px; }
        
        .btn-group { display: flex; flex-direction: column; gap: 10px; }

        button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: var(--accent-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        button:hover:not(:disabled) { opacity: 0.9; }
        
        .cost-info { font-size: 0.9em; color: #555; margin-bottom: 5px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åç›Šé€šçŸ¥) */
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }

    </style>
</head>
<body>

<header>
    <div class="resource-bar">
        <div class="res-item">ğŸ’°è³‡é‡‘: <span id="display-money">0</span></div>
        <div class="res-item">ğŸŒ²æœ¨æ: <span id="display-wood">0</span></div>
        <div class="res-item">ğŸª¨çŸ³æ: <span id="display-stone">0</span></div>
    </div>
</header>

<main>
    <div>
        <h3 style="text-align:center;">è¡—ã®ãƒãƒƒãƒ—</h3>
        <div id="map-grid">
            </div>
    </div>

    <div id="control-panel">
        <h2 id="panel-title">ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        <div id="panel-content">
            <p>ãƒãƒƒãƒ—ä¸Šã®ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å»ºè¨­ã‚„ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãŒã§ãã¾ã™ã€‚</p>
        </div>
    </div>
</main>

<div id="modal">
    <div class="modal-content">
        <h3>ãŠã‹ãˆã‚Šãªã•ã„ï¼</h3>
        <p>ä¸åœ¨ã®é–“ã«ä»¥ä¸‹ã®è³‡æºã‚’ç²å¾—ã—ã¾ã—ãŸã€‚</p>
        <p id="offline-report"></p>
        <button onclick="document.getElementById('modal').style.display='none'">å†é–‹ã™ã‚‹</button>
    </div>
</div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
    const CONFIG = {
        gridSize: 25, // 5x5
        fps: 10,
        autoSaveInterval: 5000 // 5ç§’ã”ã¨ã«ä¿å­˜
    };

    // æ–½è¨­ãƒ‡ãƒ¼ã‚¿å®šç¾©
    const BUILDINGS = {
        house: { 
            name: "æ°‘å®¶", icon: "ğŸ ", 
            baseProd: { money: 1, wood: 0, stone: 0 }, 
            baseCost: { money: 10, wood: 0, stone: 0 }, 
            baseTime: 2000 
        },
        lumber: { 
            name: "ä¼æ¡æ‰€", icon: "ğŸŒ²", 
            baseProd: { money: 0, wood: 1, stone: 0 }, 
            baseCost: { money: 50, wood: 0, stone: 0 }, 
            baseTime: 4000 
        },
        quarry: { 
            name: "æ¡çŸ³å ´", icon: "â›ï¸", 
            baseProd: { money: 0, wood: 0, stone: 1 }, 
            baseCost: { money: 100, wood: 50, stone: 0 }, // æœ¨æãŒå¿…è¦
            baseTime: 6000 
        }
    };

    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ (åˆæœŸå€¤)
    let gameState = {
        resources: { money: 100, wood: 0, stone: 0 },
        tiles: Array(CONFIG.gridSize).fill(null).map(() => ({
            type: null,
            level: 0,
            finishTime: null // å»ºè¨­å®Œäº†æ™‚åˆ»
        })),
        lastSaveTime: Date.now()
    };

    let selectedTileIndex = null;

    // --- ã‚²ãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ  ---

    function initGame() {
        loadGame();
        renderMap();
        setInterval(gameLoop, 1000 / CONFIG.fps);
        setInterval(saveGame, CONFIG.autoSaveInterval);
        
        // åˆå›æç”»
        updateUI();
    }

    // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
    function gameLoop() {
        const now = Date.now();
        
        // 1. å»ºè¨­å®Œäº†ãƒã‚§ãƒƒã‚¯
        gameState.tiles.forEach(tile => {
            if (tile.finishTime && now >= tile.finishTime) {
                tile.level++;
                tile.finishTime = null;
                if(selectedTileIndex !== null) showPanel(selectedTileIndex); // ãƒ‘ãƒãƒ«æ›´æ–°
                renderMap(); // ãƒãƒƒãƒ—æ›´æ–°
            }
        });

        // 2. è³‡æºç”Ÿç”£
        gameState.tiles.forEach(tile => {
            if (tile.type && tile.level > 0 && !tile.finishTime) {
                const b = BUILDINGS[tile.type];
                // FPSåˆ†å‰²ã—ã¦åŠ ç®—
                gameState.resources.money += (b.baseProd.money * tile.level) / CONFIG.fps;
                gameState.resources.wood += (b.baseProd.wood * tile.level) / CONFIG.fps;
                gameState.resources.stone += (b.baseProd.stone * tile.level) / CONFIG.fps;
            }
        });

        updateUI();
    }

    // UIæ›´æ–° (è³‡æºãƒãƒ¼ã¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼)
    function updateUI() {
        document.getElementById('display-money').innerText = Math.floor(gameState.resources.money);
        document.getElementById('display-wood').innerText = Math.floor(gameState.resources.wood);
        document.getElementById('display-stone').innerText = Math.floor(gameState.resources.stone);

        // å»ºè¨­ä¸­ã‚¿ã‚¤ãƒ«ã®ãƒãƒ¼æ›´æ–°
        gameState.tiles.forEach((tile, idx) => {
            if (tile.finishTime) {
                const totalTime = getBuildTime(tile.type, tile.level);
                const remaining = tile.finishTime - Date.now();
                const percent = Math.max(0, 100 - (remaining / totalTime * 100));
                
                const bar = document.getElementById(`progress-${idx}`);
                if (bar) bar.style.width = `${percent}%`;
            }
        });
    }

    // ãƒãƒƒãƒ—æç”»
    function renderMap() {
        const grid = document.getElementById('map-grid');
        grid.innerHTML = "";

        gameState.tiles.forEach((tile, index) => {
            const div = document.createElement('div');
            div.className = `tile ${selectedTileIndex === index ? 'active' : ''}`;
            div.onclick = () => selectTile(index);

            if (tile.type) {
                const info = BUILDINGS[tile.type];
                let content = `<div class="tile-icon">${info.icon}</div>`;
                content += `<div class="tile-level">Lv.${tile.level}</div>`;
                
                if (tile.finishTime) {
                    content += `<div class="progress-bar"><div class="progress-fill" id="progress-${index}"></div></div>`;
                }
                div.innerHTML = content;
            } else {
                div.innerHTML = `<span style="color:#bdc3c7;">ç©ºã</span>`;
            }
            grid.appendChild(div);
        });
    }

    // ã‚¿ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    function selectTile(index) {
        selectedTileIndex = index;
        renderMap(); // é¸æŠæ ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚å†æç”»
        showPanel(index);
    }

    // æ“ä½œãƒ‘ãƒãƒ«è¡¨ç¤º
    function showPanel(index) {
        const tile = gameState.tiles[index];
        const title = document.getElementById('panel-title');
        const content = document.getElementById('panel-content');

        if (tile.type === null) {
            // æ–°è¦å»ºè¨­ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            title.innerText = "æ–°è¦å»ºè¨­";
            let html = `<div class="btn-group">`;
            
            for (let key in BUILDINGS) {
                const b = BUILDINGS[key];
                const cost = getCost(key, 0);
                const time = (getBuildTime(key, 0)/1000).toFixed(1);
                const canAfford = checkAfford(cost);
                
                html += `
                    <div style="border:1px solid #eee; padding:5px; border-radius:5px;">
                        <strong>${b.icon} ${b.name}</strong><br>
                        <span class="cost-info">è²»ç”¨: ğŸ’°${cost.money} ğŸŒ²${cost.wood} ğŸª¨${cost.stone}</span><br>
                        <span class="cost-info">æ™‚é–“: ${time}ç§’</span><br>
                        <button onclick="build('${key}')" ${canAfford ? '' : 'disabled'}>å»ºè¨­ã™ã‚‹</button>
                    </div>
                `;
            }
            html += `</div>`;
            content.innerHTML = html;
        } else {
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            const b = BUILDINGS[tile.type];
            title.innerText = `${b.name} (Lv.${tile.level})`;
            
            if (tile.finishTime) {
                content.innerHTML = `<p>å»ºè¨­/æ‹¡å¼µå·¥äº‹ä¸­ã§ã™...</p>`;
            } else {
                const nextLv = tile.level; // ç¾åœ¨Lv0(å»ºè¨­å‰)ãªã‚‰æ¬¡ã¯Lv1ã‚³ã‚¹ãƒˆ
                const cost = getCost(tile.type, nextLv);
                const time = (getBuildTime(tile.type, nextLv)/1000).toFixed(1);
                const canAfford = checkAfford(cost);

                content.innerHTML = `
                    <p>ç”Ÿç”£åŠ›ã‚¢ãƒƒãƒ—: +${b.baseProd.money}ğŸ’° +${b.baseProd.wood}ğŸŒ² +${b.baseProd.stone}ğŸª¨</p>
                    <div class="cost-info">
                        å¿…è¦ã‚³ã‚¹ãƒˆ: ğŸ’°${cost.money} ğŸŒ²${cost.wood} ğŸª¨${cost.stone}<br>
                        æ‰€è¦æ™‚é–“: ${time}ç§’
                    </div>
                    <button onclick="upgrade()" ${canAfford ? '' : 'disabled'}>ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</button>
                `;
            }
        }
    }

    // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---

    // å»ºè¨­é–‹å§‹
    function build(type) {
        if (selectedTileIndex === null) return;
        const tile = gameState.tiles[selectedTileIndex];
        const cost = getCost(type, 0);

        if (checkAfford(cost)) {
            payCost(cost);
            tile.type = type;
            tile.level = 0; // å»ºè¨­ä¸­ã¯Lv0æ‰±ã„
            tile.finishTime = Date.now() + getBuildTime(type, 0);
            
            saveGame();
            renderMap();
            showPanel(selectedTileIndex);
        }
    }

    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é–‹å§‹
    function upgrade() {
        if (selectedTileIndex === null) return;
        const tile = gameState.tiles[selectedTileIndex];
        const cost = getCost(tile.type, tile.level);

        if (checkAfford(cost)) {
            payCost(cost);
            tile.finishTime = Date.now() + getBuildTime(tile.type, tile.level);
            
            saveGame();
            renderMap();
            showPanel(selectedTileIndex);
        }
    }

    // --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---

    function getCost(type, currentLevel) {
        const b = BUILDINGS[type];
        const multiplier = Math.pow(1.5, currentLevel);
        return {
            money: Math.floor(b.baseCost.money * multiplier),
            wood: Math.floor(b.baseCost.wood * multiplier),
            stone: Math.floor(b.baseCost.stone * multiplier)
        };
    }

    function getBuildTime(type, currentLevel) {
        const b = BUILDINGS[type];
        return Math.floor(b.baseTime * Math.pow(1.2, currentLevel));
    }

    function checkAfford(cost) {
        return gameState.resources.money >= cost.money &&
               gameState.resources.wood >= cost.wood &&
               gameState.resources.stone >= cost.stone;
    }

    function payCost(cost) {
        gameState.resources.money -= cost.money;
        gameState.resources.wood -= cost.wood;
        gameState.resources.stone -= cost.stone;
        updateUI();
    }

    // --- ã‚»ãƒ¼ãƒ– & ãƒ­ãƒ¼ãƒ‰ & ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¨ˆç®— ---

    function saveGame() {
        gameState.lastSaveTime = Date.now();
        localStorage.setItem('cityBuilderSave', JSON.stringify(gameState));
    }

    function loadGame() {
        const saved = localStorage.getItem('cityBuilderSave');
        if (saved) {
            const loadedState = JSON.parse(saved);
            
            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çµŒéæ™‚é–“ã®è¨ˆç®—
            const now = Date.now();
            const elapsedSeconds = (now - loadedState.lastSaveTime) / 1000;
            
            let earned = { money: 0, wood: 0, stone: 0 };

            loadedState.tiles.forEach(tile => {
                if (tile.type && tile.level > 0 && !tile.finishTime) {
                    const b = BUILDINGS[tile.type];
                    earned.money += b.baseProd.money * tile.level * elapsedSeconds;
                    earned.wood += b.baseProd.wood * tile.level * elapsedSeconds;
                    earned.stone += b.baseProd.stone * tile.level * elapsedSeconds;
                }
            });

            // è³‡æºåŠ ç®—
            loadedState.resources.money += earned.money;
            loadedState.resources.wood += earned.wood;
            loadedState.resources.stone += earned.stone;
            loadedState.lastSaveTime = now;

            // çŠ¶æ…‹åæ˜ 
            gameState = loadedState;

            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åç›Šãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
            if (elapsedSeconds > 10) { // 10ç§’ä»¥ä¸ŠçµŒéã—ã¦ã„ãŸã‚‰è¡¨ç¤º
                document.getElementById('offline-report').innerHTML = 
                    `ğŸ’° +${Math.floor(earned.money)}<br>ğŸŒ² +${Math.floor(earned.wood)}<br>ğŸª¨ +${Math.floor(earned.stone)}`;
                document.getElementById('modal').style.display = 'flex';
            }
        }
    }

    // é–‹å§‹
    window.onload = initGame;

</script>
</body>
</html>
